# Додавання товарів

За цим маршрутом здійснюється додавання товару в кіоск.
Якщо товар в базі даних існує - будуть перезаписані усі передані поля.
Якщо товар відсутній у бфза даних - буде створено новий запис про товар.
Пошук товару, ідентифікація товару здійсюються за штрих-кодом (ШК)

маршрут **api/products/add**
метод **POST**

приймає JSON масив обєктів

Обовязкові поля:
"product_name"
"product_code"
"barcode"
"measure"
"product_name_ua"
"product_category"
"product_subcategory"
"product_left"
"product_price"
"exposition_term"
"sale_id"
"child_product_barcode" (в окремих випадках)

приклад:
[
{
"product_name":"<String> --Назва товару--",
"product_code": "<String> --Код товару з 1С--",
"barcode": "<String> --Штрихкод товару--",
"measure":"<String> --Одиниця виміру товару (шт.)",
"product_name_ru":"<String> --Назва товару--",
"product_name_ua":"<String> --Назва товару--",
"product_description":"<String> --Опис товару (склад, поживна цінність тощо),
"product_category":"<Int> --Id категорії товару--",
"product_subcategory":"<Int> --Id підкатегорії товару--",
"product_left":"<float> --Кількість товарів, що додаються в ММ",
"product_image":"<String> --URL до зображення в локальному сходвищі ММ",
"product_price":"<float> --Ціна товару у вигляді десяткового дробу - 250.33",
"product_discount":"<float> --Не передається--",
"product_rating":"<float> --Не передається--",
"product_lot":"<Int> --Не передається--",
"exposition_term":"<Int> --Кількість днів, строк реалізації товару (для того, що швидко псується), для застосування знижок--. Можн бути NULL",
"sale_id":"<Int> --Id акції, яку необхіжно затосувати до товару. Товар без акції - id = 0",
"discount_price_1":"<float> --Не передається--",
"discount_price_2":"<float> --Не передається--",
"discount_price_3":"<float> --Не передається--",
"updatedAt":"<DateTime> --Не передається--",
"combo_id":"<Int> --Не передається--",
"child_product_barcode": "<String> --Штрихкод 'парного' товару для акції Комбо. Обовязково передається, якщо товара акція id = 7 (Комбо)--",
"is_VAT_Excise": <boolean> - якщо true - товар може продаватися тільки з ПДВ (акцизом). Потрібно передавати "product_price_no_VAT" та "VAT_value",
якщо false - товар може продавати з або без ПДВ,
"exsice_product": boolean,
"is_new_product": boolean,
}
]

Дані про додавання товару (поставка товару) зберігаються у таблиці LoadProducts:
{
product_id: id доданого продукту,
load_date: дата додавання,
load_quantity: кількість доданого продукту,
lotIsActive: - приймає значення true або false та вказує, чи відображати ці товари в кіоску,
products_left: залишок продуктів,
sale_id: id акції товару або 0, якщо товар без акції,
child_product_barcode: штрихкод залежного продукту (наприклад в акції "комбо") || null,
load_date_time: дата і час поставки,
}

При додаванні продукту перевіряється папка з зображеннями. Якщо зображення відповідає штрихкоду - воно присвоюється продукту.
Якщо зображення не знайдено - присвоюється дефолтне зображення.

# Продаж товару

При продажу товару кіоск робить **POST** запит з товарами з корзини за маршрутом **api/cart/buy**.
Дані про проданий товар додаються в таблицю **RemoveProducts**
В таблиці зберіаються дані про проданий товар, дані банківського терміналу, платіжні реквізити.
В таблиці вказується id типу списання товару "1" - продаж.
В таблиці **LoadProducts** відповідно зменшується кількість товару в колонці products_left, або ставиться 0. Якщо кількість товару 0 -
поставка (лот) стає неактивним lotIsActive: false.

# Списання товару

Списання відбувається шляхом передання **POST** запиту на **api/products/withdraw**
Обробник приймає JSON масив у вигляді:
[
{
"barcode": <String> --Штрихкод товару--",
"quantity": <String || Int> --Ключове слово "all" або кількість товару--",
"limit": <String> --Ключове слово "not-last" або порожній рядок--",
},
{
"barcode": "5900617034786",
"quantity": 5,
"limit": ""
}
]

"quantity" - вказується число товару для списання або ключове слово. У разі передання числа - система "списує" продукти, починаючи від найстарішого.
Відповідні записи про "списання" додаються в таблицю **RemoveProducts**, в таблиці вказується id типу списання товару "3" - списання
Якщо у параметр "limit" передано "not-last" - товари з останньої поставки не будуть видалені.
Якщо передати "quantity": "all" та "limit":"not-last" - будуть списані всі товари, крім останньої поставки. Якщо limit":"" - будуть списані всі товари.
В таблиці **LoadProducts** зменшується кількість товару в колонці products_left, або ставиться 0. Якщо кількість товару 0 -
поставка (лот) стає неактивним lotIsActive: false.

# Додавання зображень

Зображення передаються масивом обєктів **api/products/image** методом **POST**
[
{
"productImage": <String> --Base64 закодоване зображення--,
"fileName": <String> --назва файлу у форматі штрих-коду, наприклад "8593893745841.webp"
}
]

Кожне зображення зберігається в кіоску локально у папці "C:/mm-images"
Якщо імя файлу в папці вже існує - файл перезапишеться. Тобто для кожного ШК одночасно існує лише 1 зображення.
Посилання на зображення передається в таблицю **Products** у відповідний продукт, колонка product_image.

# Оновлення даних продукту

Обробник для збереження нових даних про продукт, які не повязані з додаванням або списанням товарів.
Маршрут **api/products/update**, метод **POST**
Приймає JSON масив обєктів.
Обовязковим є передавання ШК товару та даних, які необхідно оновити.
Система перевіряє наявність штрихкоду та перелік ключів. Якщо штрих-код не передано - помилка (400), якщо передано не існуючі поля для оновлення - помилка (400).
Якщо передано товари з зазначенням категорій і цих категорій (підкатегорій) не існує - система поверне такі продуки. Решту - збереже до бази даних.
Якщо система відповіла 200 - дані тимчасово записані у файл. Коли кіоск перейде в режим очікування (коли користувач не взаємодіє з кіоском - дані зберігаються в БД, тимчасові дані видаляються)

# Додавання категорії товарів

За маршрутом **api/config/category** методом **POST** передається JSON обєкт:
{
category_name: <String> - назва категорії,
category_discount: <Float> знижка по категрії (у вигляді десяткового дробу, напр. 0.15 - це 15% знижка) або null,
category_image: <String> шлях до зображення категріх або пустий рядок "",
cat_1C_id: <Int> - id категрії товарів згідно 1С,
}

Якщо id категрії товарів згідно 1С вже існує - повернеться помилка 400
Кожній новій категорії призначається індекс пріоритету (впливає на сортування категорій на екрані кіоску).
Індекс за замовчуванням призначається як +1 до максимального значення індексу

# Редагування категорії

За маршрутом **api/config/category** методом **PATCH** передається JSON обєкт:

{
category_name: <String> - назва категорії,
category_discount: <Float> знижка по категрії (у вигляді десяткового дробу, напр. 0.15 - це 15% знижка) або null,
cat_1C_id: <Int> - id категрії товарів згідно 1С,
category_priority: <Int> - значення приоритету (1 - найвищий, 2 - нижчий, 3 - нижчий і т.д.)
}

Обовязково передається cat_1C_id - ідентифікатор категорії. Якщо не передано - помилка 400.
Інші поля за необхідністю. Якщо передати вжу існуючий "пріоритет" категорії - цей пріоритет буде присвоєно цій же категорії, а категорія, яка мала цей пріоритет до цього - отримає "старий" пріоритет категорії, що оновлюється.

# Додавання зображень категорій

За маршрутом **api/config/category-image** методом **POST** передається JSON масив:

[
{
"categoryImage": <String> --Base64 закодоване зображення--,
"fileName": <String> --оригінальна назва файлу з розширенням",
"categoryId": <Int> id категрії товарів згідно 1С
}
]

Усі поля обовязкові. При відсутності даних у полях або якомусь одному - повертається помилка.

# Додавання підкатегроії

За маршрутом **api/config/subcategory** методом **POST** передається JSON обєкт:

[
{
subcategory_name: <String> - назва підкатегорії,
subcategory_discount: <Float> знижка по категрії (у вигляді десяткового дробу, напр. 0.15 - це 15% знижка) або null,,
subcat_1C_id: <Int> - id підкатегрії товарів згідно 1С,
cat_1C_id: <Int> - id батьківської категрії товарів згідно 1С
}
]

Якщо cat_1C_id не передано, або у базі даних відсутня така батьківська категорія - підкатегорія не буде додана. Повернеться помилка 400

# Оновлення, переміщення підкатегроії

За маршрутом **api/config/subcategory** методом **PATCH** передається JSON масив обєктів:
Для будь-якої взаємодії по маршруту необхідно передати валідні subcat_1C_id та cat_1C_id.

## Змінити дисконт та назву підкатегорії 
[
{
subcategory_name: <String> - назва підкатегорії,
subcategory_discount: <Float> знижка по категрії (у вигляді десяткового дробу, напр. 0.15 - це 15% знижка) або null,,
subcat_1C_id: <Int> - id підкатегрії товарів згідно 1С,
cat_1C_id: <Int> - id батьківської категрії товарів згідно 1С
}
]
Цим буде оновлено назву та дисконт підкатегорії


## Змінити 1С_id підкатегорії без зміни 1С_id категорії

[
{
subcategory_name: <String> - назва підкатегорії (якщо не передати - буде використана попредня назва),
subcategory_discount: <Float> знижка по категрії (у вигляді десяткового дробу, напр. 0.15 - це 15% знижка) або null,,
subcat_1C_id: <Int> - id поточної підкатегрії товарів згідно 1С, яку буде змінено
cat_1C_id: <Int> - id батьківської категрії товарів згідно 1С
new_subcat_1C_id: <Int> - id нової підкатегрії товарів згідно 1С. Має бути уникальна та не використовуватися на кіоску на момент оновлення. В іншому випадку буде помилка

}
]

## Змінити 1С_id підкатегорії та 1С_id категорії

[
{
subcategory_name: <String> - назва підкатегорії (якщо не передати - буде використана попредня назва),
subcategory_discount: <Float> знижка по категрії (у вигляді десяткового дробу, напр. 0.15 - це 15% знижка) або null,,
subcat_1C_id: <Int> - id поточної підкатегрії товарів згідно 1С,яку буде змінено
cat_1C_id: <Int> - id поточної батьківської категрії товарів згідно 1С, яку буде змінено
new_subcat_1C_id: <Int> - id нової підкатегрії товарів згідно 1С. Має бути уникальна та не використовуватися на кіоску на момент оновлення. В іншому випадку буде помилка
new_cat_1C_id: <Int> - id нової батьківської категрії товарів згідно 1С. Має бути уникальна та не використовуватися на кіоску на момент оновлення. В іншому випадку буде помилка

}
]

ПРИ ЗМІНІ ПІДКАТЕГОРІЇ - ОНОВЛЮЮТЬСЯ ДАНІ НА КОЖНОМУ ПРОДУКТІ, ЯКИЙ МАВ ПОПЕРЕДНЮ ПІДКАТЕГОРІЮ

# Додавання акції магазину (екран очікування)

Акція "вішається" на магазин. В параметрах передається категорія та підкатегорія товарів, які будуть
демонструватися на екрані очікування, з поміткою "акція" і відповідною знижкою.

За маршрутом **api/config/store-sale** методом **POST** передається JSON обєкт:
{
store_sale_product_category: <Int> - 1С ідентифікатор категорії,
store_sale_product_subcategory:<Int> - 1С ідентифікатор підкатегорії,
store_sale_name: <String> - назва акції, наприклад "Знижка",
store_sale_title: <String> - заголовок акції, наприклад "знижка на вафлі"
store_sale_discount: <Float> - розмір знижки у вигляді десяткового дробу (0.15 = 15%),
}

# Мерчанти кіоску

Якщо в кіоску використовуєтья 2 мерчанти - обовязково потрібно передати id мерчанта в VAT_excise_merchant.
Також в default_merchant_taxgrp (основний мерчант) та в VAT_merchant_taxgrp (додатковий мерчант) потрібно передати групу оподаткування згідно vchasno.kasa API:
1 ПДВ 20%  
2 Без ПДВ  
3 ПДВ 20% + акциз 5%  
4 ПДВ 7%  
5 ПДВ 0%  
6 Без ПДВ + акциз 5%  
7 Не є об`єктом ПДВ  
8 ПДВ 20% + ПФ 7.5%  
9 ПДВ 14%  
10 ПДФО 18% ВЗ 1.5%

Також БД містить boolean значення для фільтрації продукців і цін, враховуючи марчантів: use_VAT_by_default та is_single_merchant
Колонка is_single_merchant вказує, чи підключено 1 чи 2 мерчантів (де true - якщо тільки 1 мерчант (ФОП) або false - якщо 2 мерчанти (ФОП і ТОВ))
Колонка use_VAT_by_default - вказує, чи використовувати ціну з ПДВ для всіх товарів (якщо true - усі ціни з ПДВ, якщо false - диференційовано, залежно
від колонки Products.is_VAT_Excise). Якщо на продукті is_VAT_Excise = true - товар продається тільки з ПДВ і тільки від додаткового мерчанта.

## Модель - продавець тільки ФОП

    Для цієї моделі передаються значення:
        is_single_merchant = true та use_VAT_by_default = false.
        Товари з is_VAT_Excise = true - не будуть доступні в кіоску.
        Всі товари продаються без ПДВ

## Модель - продавці ФОП та ТОВ

    Для цієї моделі передаються значення:
        is_single_merchant = false та use_VAT_by_default = false
        Товари з is_VAT_Excise = true - будуть доступні в кіоску та будуть реалізовуватись від ТОВ.

## Модель - продавець ТОВ

    Для цієї моделі передаються значення:
        is_single_merchant = true та use_VAT_by_default = true
        Усі товари реалізовуються з ПДВ.

## Недопустиме значення

        is_single_merchant = false та use_VAT_by_default = true
        Тобто не може бути кілька продавців з ПДВ та продаж усіх товарів з ПДВ - немає логіки розділення товарів між продавцями.

# Додавання/оновлення мерчатнів

За маршрутом **api/config/merchant** методом **POST** передається JSON-обєкт:
{
"defaultMerchant" - <String> - ідентифікатор основного мерчанта, наданий банком,
"vatExciseMerchant" - <String> - ідентифікатор додаткового мерчанта, наданий банком,
"useVATbyDefault" <Boolean> - чи використовувати ціну з ПДВ для всіх товарів (якщо true - усі ціни з ПДВ, якщо false - диференційовано, залежно
від колонки Products.is_VAT_Excise),
"isSingleMerchant" <Boolean> - чи підключено 1 чи 2 мерчантів (де true - якщо тільки 1 мерчант (ФОП) або false - якщо 2 мерчанти (ФОП і ТОВ)),
"defaultMerchantTaxgrp" <Int> - ідентифікатор податкової групи згідно vchasno.kasa API для основного мерчанта,
"vatExciseMerchantTaxgrp" <Int> - ідентифікатор податкової групи згідно vchasno.kasa API для додаткового мерчанта,
}

/api/finance метод GET

{

    "start": start date 2025-02-10
    "end": end date 2025-02-15
    "type": 3 //списання

}
